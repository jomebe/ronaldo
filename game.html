<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket ë©€í‹°í”Œë ˆì´ ì¶•êµ¬ê²Œì„</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      text-align: center;
      font-family: 'Poppins', sans-serif;
      background: #1a1a1a;
      color: white;
      padding: 20px;
    }

    h1 {
      color: #fff;
      margin-bottom: 20px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    canvas {
      border: 3px solid #333;
      border-radius: 10px;
      display: block;
      margin: 0 auto;
      background: linear-gradient(to right, #1a472a, #2d5a3f);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .game-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .score {
      font-size: 28px;
      margin: 20px;
      background: #2a2a2a;
      padding: 15px 30px;
      border-radius: 15px;
      display: inline-block;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .score span {
      margin: 0 15px;
      font-weight: 600;
    }

    .blue-score { color: #4a9eff; }
    .red-score { color: #ff4a4a; }

    .controls {
      margin: 20px auto;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 15px;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .controls p {
      margin: 10px 0;
      color: #ddd;
    }

    .player-list {
      margin: 20px;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 15px;
      display: inline-block;
      min-width: 200px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .player-list h3 {
      color: #fff;
      margin-bottom: 10px;
    }

    .player-list div {
      margin: 5px 0;
      padding: 5px;
      border-radius: 5px;
      background: #333;
    }

    #powerMeter {
      width: 200px;
      height: 20px;
      background: #333;
      margin: 20px auto;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #powerBar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #4a9eff, #ff4a4a);
      transition: width 0.1s;
    }

    #status {
      font-size: 24px;
      font-weight: 600;
      height: 36px;
      margin: 10px 0;
      transition: all 0.3s;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>âš½ WebSocket ë©€í‹°í”Œë ˆì´ ì¶•êµ¬ê²Œì„</h1>
    <div class="score">
      <span class="blue-score" id="blueScore">Blue: 0</span> - 
      <span class="red-score" id="redScore">Red: 0</span>
    </div>
    <div class="player-list">
      <h3>ğŸ‘¥ ì ‘ì†ì ëª©ë¡</h3>
      <div id="playerList"></div>
    </div>
    <div id="powerMeter"><div id="powerBar"></div></div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <p id="status"></p>
    <div class="controls">
      <p>ğŸ® ì¡°ì‘ë²•</p>
      <p>ì´ë™: ë°©í–¥í‚¤ | ìŠˆíŒ…: ìŠ¤í˜ì´ìŠ¤ë°”(ê¸¸ê²Œ ëˆ„ë¥¼ìˆ˜ë¡ ê°•ë ¥) | ëŒ€ì‹œ: Shift</p>
    </div>
  </div>













  
  <script>
    // WebSocket ì„œë²„ ì£¼ì†Œ (ë¡œì»¬ ê°œë°œ í™˜ê²½)
    const WS_SERVER = 'wss://ronaldo-31b9.onrender.com/ws';

    // DOM ìš”ì†Œ ìºì‹±
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const powerBar = document.getElementById('powerBar');
    const statusElement = document.getElementById('status');

    // ê³¨ëŒ€ í¬ê¸° ìƒìˆ˜
    const GOAL_SIZE = {
      width: 20,
      height: 100
    };

    // WebSocket ì—°ê²° ìƒíƒœ ê´€ë¦¬
    let socket = null;
    let isConnected = false;

    // íŒ€ê³¼ í”Œë ˆì´ì–´ ì´ë¦„ ì´ˆê¸°í™”
    const playerName = sessionStorage.getItem('playerName') || generatePlayerName();
    const playerTeam = sessionStorage.getItem('playerTeam') || (Math.random() < 0.5 ? 'blue' : 'red');

    const localPlayer = {
      id: generateUniqueId(),
      x: playerTeam === 'blue' ? 150 : 650,
      y: canvas.height / 2,
      width: 30,
      height: 30,
      color: playerTeam === 'blue' ? '#4a9eff' : '#ff4a4a',  // ì´ë ‡ê²Œ ìˆ˜ì •
      score: 0,
      team: playerTeam,
      name: playerName,
      powerCharge: 0,
      lastActive: Date.now()
    };

    // ê³µ ì´ˆê¸° ìƒíƒœ
    let ball = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      radius: 10,
      vx: 0,
      vy: 0,
      lastUpdate: Date.now()
    };

    // ê²Œì„ ìƒíƒœ ë³€ìˆ˜ë“¤
    let players = {};
    const keys = {
      ArrowUp: false,
      ArrowDown: false,
      ArrowLeft: false,
      ArrowRight: false,
      Space: true,
      Shift: false
    };
    let scores = { blue: 0, red: 0 };
    let lastUpdateTime = Date.now();

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ê³ ìœ  ID ìƒì„±
    function generateUniqueId() {
      return Math.random().toString(36).substring(2) + Date.now().toString(36);
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ëœë¤ í”Œë ˆì´ì–´ ì´ë¦„ ìƒì„±
    function generatePlayerName() {
      const adjectives = ['ë¹ ë¥¸', 'ê°•í•œ', 'ë‚ ìŒ˜', 'ë¯¼ì²©í•œ', 'ìŠˆí¼'];
      const nouns = ['ì„ ìˆ˜', 'ê³µê²©ìˆ˜', 'ê³¨í‚¤í¼', 'ìŠ¤íŠ¸ë¼ì´ì»¤', 'í”Œë ˆì´ë©”ì´ì»¤'];
      return `${adjectives[Math.floor(Math.random() * adjectives.length)]} ${nouns[Math.floor(Math.random() * nouns.length)]}_${Math.floor(Math.random() * 1000)}`;
    }

    // WebSocket ì—°ê²° í•¨ìˆ˜
    function connectWebSocket() {
      socket = new WebSocket(WS_SERVER);

      socket.onopen = handleWebSocketOpen;
      socket.onmessage = handleWebSocketMessage;
      socket.onclose = handleWebSocketClose;
      socket.onerror = handleWebSocketError;
    }

    // WebSocket ì—´ê¸° í•¸ë“¤ëŸ¬
    function handleWebSocketOpen() {
      console.log('WebSocket connection established');
      isConnected = true;
      statusElement.textContent = 'ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.';
      
      socket.send(JSON.stringify({
        type: 'connect',
        player: localPlayer
      }));
    }

    // WebSocket ë©”ì‹œì§€ í•¸ë“¤ëŸ¬
    function handleWebSocketMessage(event) {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case 'player_list':
          players = data.players;
          updatePlayerList(players);
          break;
          case 'game_state':
          // ê²Œì„ ìƒíƒœ ì™„ì „íˆ ìƒˆë¡œê³ ì¹¨
          players = data.players || {};
          ball = data.ball || { x: canvas.width / 2, y: canvas.height / 2, radius: 10, vx: 0, vy: 0 };
          
          // ë¡œì»¬ í”Œë ˆì´ì–´ì˜ íŒ€ê³¼ ìœ„ì¹˜ ì„¤ì •
          if (data.team) {
            localPlayer.team = data.team;
            localPlayer.color = data.team;
            localPlayer.x = data.team === 'blue' ? 100 : 700;
          }
          
          updatePlayerList(players);
          break;
        case 'ball_update':
          updateBallState(data.ball);
          break;
        case 'player_update':
           // ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
          players[data.playerId] = data.player;
          break;
        case 'scores_update':
          updateScores(data.scores);
          break;
        case 'player_joined':
          players[data.player.id] = data.player;
          updatePlayerList(players);
          break;
        case 'player_left':
          delete players[data.playerId];
          updatePlayerList(players);
          break;
        case 'team_assignment':
          localPlayer.team = data.team;
          localPlayer.color = data.team;
          break;
      }
    }

    // WebSocket ë‹«ê¸° í•¸ë“¤ëŸ¬
    function handleWebSocketClose() {
      console.log('WebSocket connection closed');
      isConnected = false;
      statusElement.textContent = 'ì„œë²„ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...';
      setTimeout(connectWebSocket, 3000);
    }

    // WebSocket ì—ëŸ¬ í•¸ë“¤ëŸ¬
    function handleWebSocketError(error) {
      console.error('WebSocket Error:', error);
      statusElement.textContent = 'ì„œë²„ ì—°ê²° ì˜¤ë¥˜ ë°œìƒ';
    }

    // í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePlayerList(playerList) {
      const playerListElement = document.getElementById('playerList');
      playerListElement.innerHTML = '';
      
      Object.values(playerList).forEach(player => {
        const div = document.createElement('div');
        div.textContent = `${player.name} (${player.team})`;
        div.style.color = player.team === 'blue' ? '#4a9eff' : '#ff4a4a';
        playerListElement.appendChild(div);
      });
    }

    // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateGameState(data) {
      players = data.players || {};
      ball = data.ball || { x: canvas.width / 2, y: canvas.height / 2, radius: 10, vx: 0, vy: 0 };
      
      if (data.team) {
        localPlayer.team = data.team;
        localPlayer.color = data.team;
        localPlayer.x = data.team === 'blue' ? 100 : 700;
      }
      
    }

    // ê³µ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateBallState(newBallState) {
      ball.x = newBallState.x;
      ball.y = newBallState.y;
      ball.vx = newBallState.vx;
      ball.vy = newBallState.vy;
    }

    // ì ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateScores(newScores) {
      scores = newScores;
      document.getElementById('blueScore').textContent = `Blue: ${scores.blue}`;
      document.getElementById('redScore').textContent = `Red: ${scores.red}`;
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    function addKeyboardListeners() {
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);
    }

    // í‚¤ ë‹¤ìš´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function handleKeyDown(e) {
      if (!keys[e.code]) {
        keys[e.code] = true;
        
        // íŒŒì›Œ ì°¨ì§•
        if (e.code === 'Space') {
          localPlayer.powerCharge = Math.min(100, localPlayer.powerCharge + 5);
          updatePowerBar();
        }
      }

      // ì„œë²„ì— í‚¤ ìƒíƒœ ì „ì†¡
      sendKeyInputToServer();
    }

    // í‚¤ ì—… ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function handleKeyUp(e) {
      keys[e.code] = false;

      if (e.code === 'Space') {
        if (localPlayer.powerCharge > 0) {
          kickBall(localPlayer.powerCharge);
          localPlayer.powerCharge = 0;
          updatePowerBar();
        }
      }

      // ì„œë²„ì— í‚¤ ìƒíƒœ ì „ì†¡
      sendKeyInputToServer();
    }

    // ì„œë²„ì— í‚¤ ì…ë ¥ ì „ì†¡
    function sendKeyInputToServer() {
      if (isConnected) {
        socket.send(JSON.stringify({
          type: 'player_input',
          keys: keys
        }));
      }
    }

    // íŒŒì›Œ ë°” ì—…ë°ì´íŠ¸
    function updatePowerBar() {
      powerBar.style.width = `${localPlayer.powerCharge}%`;
    }

    // ê³µ ì°¨ê¸°
    function kickBall(power) {
      
      const dx = ball.x - (localPlayer.x + localPlayer.width/2);
      const dy = ball.y - (localPlayer.y + localPlayer.height/2);
      const angle = Math.atan2(dy, dx);
      const kickPower = power * 0.2;
      
      if (isConnected) {
        socket.send(JSON.stringify({
          type: 'ball_kick',
          power: kickPower,
          angle: angle
        }));
      }
    }

    // ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function draw() {
      ctx.fillStyle = '#1a472a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      drawGoals();
      drawPlayers();
      drawBall();
    }

    // ê³¨ëŒ€ ê·¸ë¦¬ê¸°
    function drawGoals() {
      ctx.fillStyle = 'white';
      ctx.fillRect(0, (canvas.height - GOAL_SIZE.height) / 2, GOAL_SIZE.width, GOAL_SIZE.height);
      ctx.fillRect(canvas.width - GOAL_SIZE.width, (canvas.height - GOAL_SIZE.height) / 2, GOAL_SIZE.width, GOAL_SIZE.height);
    }

    // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
    function drawPlayers() {
      Object.values(players).forEach(player => {
        if (player.id !== localPlayer.id) {
          //alert(player.team);
          ctx.fillStyle = player.color || (player.team === 'blue' ? '#4a9eff' : '#ff4a4a');
          ctx.fillRect(player.x, player.y, player.width, player.height);
        }
      });

      // ë¡œì»¬ í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
      ctx.fillStyle = localPlayer.team === 'blue' ? '#4a9eff' : '#ff4a4a';
      ctx.fillRect(localPlayer.x, localPlayer.y, localPlayer.width, localPlayer.height);
    }

    // ê³µ ê·¸ë¦¬ê¸°
    function drawBall() {
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
      ctx.fillStyle = 'white';
      ctx.fill();
    }

    // ê³µ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateBall() {
    
      const currentTime = Date.now();
      const deltaTime = (currentTime - lastUpdateTime) / 1000;
      lastUpdateTime = currentTime;
    
      // ê³µ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      ball.x += ball.vx * deltaTime * 60;
      ball.y += ball.vy * deltaTime * 60;
    
      // ë²½ ì¶©ëŒ ì²˜ë¦¬
      handleWallCollision();
    
      // í”Œë ˆì´ì–´ ì¶©ëŒ ì²˜ë¦¬
      handlePlayerCollisions();
    
      // ë§ˆì°°ë ¥ ì ìš©
      applyFriction();
    
      // ê³¨ ì²´í¬
      checkGoal();
    
      // ì‘ì€ ì†ë„ëŠ” 0ìœ¼ë¡œ ë§Œë“¤ê¸°
      resetLowSpeeds();
    
      // WebSocketìœ¼ë¡œ ball ìƒíƒœ ì „ì†¡
      sendBallUpdate();
    }

    // ë²½ ì¶©ëŒ ì²˜ë¦¬
    function handleWallCollision() {
      if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) {
        ball.vx *= -0.8;
        ball.x = ball.x - ball.radius < 0 ? ball.radius : canvas.width - ball.radius;
      }
    
      if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
        ball.vy *= -0.8;
        ball.y = ball.y - ball.radius < 0 ? ball.radius : canvas.height - ball.radius;
      }
    }

    // í”Œë ˆì´ì–´ ì¶©ëŒ ì²˜ë¦¬
    function handlePlayerCollisions() {
      const playerList = [...Object.values(players), localPlayer];
    
      playerList.forEach(player => {
        if (checkCollision(ball, player)) {
          const dx = ball.x - (player.x + player.width / 2);
          const dy = ball.y - (player.y + player.height / 2);
          const angle = Math.atan2(dy, dx);
    
          // ê³µì´ ë©ˆì¶°ìˆì„ ê²½ìš° ìµœì†Œ ì†ë„ë¥¼ ì„¤ì •
          const minSpeed = 3; // ìµœì†Œ ì†ë„
          if (ball.vx === 0 && ball.vy === 0) {
            ball.vx = Math.cos(angle) * minSpeed;
            ball.vy = Math.sin(angle) * minSpeed;
          } else {
            // ê³µì´ ì›€ì§ì´ê³  ìˆë‹¤ë©´ ê¸°ì¡´ ë¡œì§ ì ìš©
            const collisionForce = 5;
            ball.vx = Math.cos(angle) * collisionForce;
            ball.vy = Math.sin(angle) * collisionForce;
          }
        }
      });
    }
    
    
    // ë§ˆì°°ë ¥ ì ìš©
    function applyFriction() {
      ball.vx *= 0.98;
      ball.vy *= 0.98;
    }

    // ë‚®ì€ ì†ë„ ë¦¬ì…‹
    function resetLowSpeeds() {
      if (Math.abs(ball.vx) < 0.01) ball.vx = 0;
      if (Math.abs(ball.vy) < 0.01) ball.vy = 0;
    }

    // ê³µ ìƒíƒœ ì „ì†¡
    function sendBallUpdate() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'ball_update',
          ball: ball
        }));
      }
    }

    // ì¶©ëŒ ì²´í¬ í•¨ìˆ˜
    function checkCollision(ball, player) {
      const dx = ball.x - Math.max(player.x, Math.min(ball.x, player.x + player.width));
      const dy = ball.y - Math.max(player.y, Math.min(ball.y, player.y + player.height));
      return (dx * dx + dy * dy) < (ball.radius * ball.radius);
    }

    // ê³¨ ì²´í¬ í•¨ìˆ˜
    function checkGoal() {
      // ì™¼ìª½ ê³¨ëŒ€ (blue íŒ€)
      if (ball.x - ball.radius < GOAL_SIZE.width && 
          ball.y > (canvas.height - GOAL_SIZE.height) / 2 && 
          ball.y < (canvas.height + GOAL_SIZE.height) / 2) {
        scores.red++;
        celebrateGoal('red');
        resetBall();
        return true;
      } 
      // ì˜¤ë¥¸ìª½ ê³¨ëŒ€ (red íŒ€)
      else if (ball.x + ball.radius > canvas.width - GOAL_SIZE.width && 
               ball.y > (canvas.height - GOAL_SIZE.height) / 2 && 
               ball.y < (canvas.height + GOAL_SIZE.height) / 2) {
        scores.blue++;
        celebrateGoal('blue');
        resetBall();
        return true;
      }
      return false;
    }

    // ê³¨ ì‹œ ì¶•í•˜ í•¨ìˆ˜
    function celebrateGoal(team) {
      statusElement.textContent = `ğŸ‰ ${team.toUpperCase()} íŒ€ ê³¨!!!`;
      statusElement.style.color = team === 'blue' ? '#4a9eff' : '#ff4a4a';
      setTimeout(() => {
        statusElement.textContent = '';
      }, 2000);
    
      // ì ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ì„œë²„ì— ì „ì†¡
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'scores_update',
          scores: scores
        }));
      }
    }

    // ê³µ ë¦¬ì…‹ í•¨ìˆ˜
    function resetBall() {
      ball = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        radius: 10,
        vx: 0,
        vy: 0,
        lastUpdate: Date.now()
      };
    
      // ê³µ ë¦¬ì…‹ì„ ì„œë²„ì— ì „ì†¡
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'ball_update',
          ball: ball
        }));
      }
    }

   

    // ë¡œì»¬ í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateLocalPlayer() {
      const baseSpeed = 2;
      const dashSpeed = keys.Shift ? 4 : 1;
      const speed = baseSpeed * dashSpeed;
    
      if (keys.ArrowUp) localPlayer.y -= speed;
      if (keys.ArrowDown) localPlayer.y += speed;
      if (keys.ArrowLeft) localPlayer.x -= speed;
      if (keys.ArrowRight) localPlayer.x += speed;
    
      // ìº”ë²„ìŠ¤ ê²½ê³„ ì œí•œ
      localPlayer.x = Math.max(0, Math.min(canvas.width - localPlayer.width, localPlayer.x));
      localPlayer.y = Math.max(0, Math.min(canvas.height - localPlayer.height, localPlayer.y));
    
      // í”Œë ˆì´ì–´ ìƒíƒœë¥¼ ì„œë²„ì— ì „ì†¡
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          type: 'player_update',
          playerId: localPlayer.id,
          player: localPlayer
        }));
      }
  }

    // ê²Œì„ ë£¨í”„
    function gameLoop() {
      updateLocalPlayer();
        updateBall();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜
    function init() {
      connectWebSocket();
      addKeyboardListeners();
      gameLoop();

      // ì°½ì´ ë‹«í ë•Œ ì—°ê²° ì¢…ë£Œ
      window.addEventListener('beforeunload', () => {
        if (isConnected) {
          socket.send(JSON.stringify({
            type: 'disconnect',
            playerId: localPlayer.id
          }));
          socket.close();
        }
      });
    }

    // ê²Œì„ ì‹œì‘
    init();
  </script>
</body>
</html>